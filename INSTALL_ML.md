# Установка ML системы для детекции объектов

Эта система использует YOLOv8 для детекции объектов на картах и MobileNetV2 для извлечения признаков, что позволяет эффективно работать с картами разрешением 15000x15000+ пикселей.

## Преимущества ML подхода

- ✅ **Не зависит от цвета**: Векторное представление объектов работает при любых условиях освещения и сезонных изменениях
- ✅ **Большие карты**: Оптимизированная многоуровневая система поиска для карт 15000x15000+
- ✅ **Разумный поиск**: Сравнивает объекты (дома, дороги, водоемы), а не попиксельно
- ✅ **Устойчивость**: Работает при различиях в углах обзора, масштабе и перспективе

## Установка

### 1. Активируйте виртуальное окружение

```bash
source venv/bin/activate
```

### 2. Установите зависимости

```bash
pip install ultralytics torch torchvision
```

### Рекомендации по установке PyTorch

#### Для CPU:

```bash
pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
```

#### Для GPU (CUDA):

**Для CUDA 11.8:**
```bash
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
```

**Для CUDA 12.1:**
```bash
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121
```

**Для CUDA 12.4 (последняя версия):**
```bash
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu124
```

### 3. Установите остальные зависимости

```bash
pip install ultralytics
```

Или все сразу:
```bash
pip install -r requirements.txt
```

## Проверка установки

После установки запустите приложение:

```bash
python app.py
```

Вы должны увидеть:

```
Инициализация ML моделей...
Устройство: cuda  # или cpu
✓ YOLOv8-n загружен
✓ MobileNetV2 загружен для извлечения признаков
✓ ML модели готовы к работе
✓ ML система загружена (ObjectMatcher на YOLOv8)
```

## Автоматическое переключение

Если ML библиотеки не установлены, система автоматически использует традиционный ORB метод:

```
⚠ ML библиотеки недоступны. Переключение на ORB метод.
✓ Используется традиционный ORB метод
```

Это полностью функциональный режим - все функции работают, кроме оптимизации для больших карт.

## Использование

ML система активируется автоматически при запуске приложения если:
1. PyTorch установлен
2. ultralytics установлен
3. Веса YOLOv8 загружаются (автоматически при первом запуске)

### Примечания о производительности

- **Первая загрузка**: При первом запуске YOLOv8 автоматически загрузит веса модели (~6MB для yolov8n.pt)
- **Скорость**: Обработка зависит от размера карты и количества объектов
  - Маленькие карты (< 5000x5000): ~1-3 секунды
  - Средние карты (5000-10000): ~3-10 секунд
  - Большие карты (15000+): ~10-30 секунд
- **GPU**: На GPU обработка в 10-50 раз быстрее

### Настройка модели

В `app.py` можно настроить:

```python
matcher = ObjectMatcher(
    model_size='n',              # 'n' (nano) - самое быстрое, 's', 'm', 'l', 'x' - точнее но медленнее
    confidence_threshold=0.25     # Порог уверенности детекции (0.0-1.0)
)
```

Размеры моделей YOLOv8:
- `n` - Nano (~6MB) - быстро, достаточно точно
- `s` - Small (~22MB) - баланс скорости и точности
- `m` - Medium (~52MB) - высокая точность
- `l` - Large (~88MB) - очень высокая точность
- `x` - XLarge (~136MB) - максимальная точность

## Архитектура системы

### Многоуровневый поиск

Для карт размером 5000x5000+ используется двухуровневая система поиска:

**Уровень 1: Грубое сканирование**
- Сканирует карту с шагом 1500 пикселей
- Быстро находит потенциальные кандидаты
- Ограничивает область поиска

**Уровень 2: Детальное уточнение**
- Сканирует окрестности лучших кандидатов с шагом 250 пикселей
- Точное определение позиции
- Финальная оценка уверенности

### Извлечение признаков

Каждый обнаруженный объект описывается комбинацией:

1. **Гистограммы цветов** (HSV): 96 признаков
2. **Плотность краев**: Устойчивость к текстурам
3. **Вариация яркости**: Информация о текстуре
4. **MobileNetV2 features**: 256 признаков из предобученной CNN

Всего: ~355 признаков на объект

### Сравнение объектов

Объекты сравниваются по косинусному расстоянию между их векторными представлениями, что позволяет находить один и тот же объект при:
- Разных условиях освещения
- Разных сезонах (лето/зима)
- Разных углах обзора
- Разных цветовых схемах карт

## Решение проблем

### Ошибка: "YOLO/PyTorch не установлены"

Установите зависимости:
```bash
pip install ultralytics torch torchvision
```

### Ошибка: "CUDA out of memory"

Используйте модель меньшего размера или увеличите шаг поиска:
```python
matcher = ObjectMatcher(model_size='n', confidence_threshold=0.3)
```

### Медленная работа на CPU

Это нормально. ML система оптимизирована для GPU. На CPU может работать медленнее традиционного ORB метода.

### Не находит совпадения

- Снизьте `confidence_threshold` (например, до 0.15)
- Используйте более точную модель ('s' или 'm')
- Проверьте, что на изображениях есть узнаваемые объекты

## Сравнение с ORB методом

| Характеристика | ML метод | ORB метод |
|----------------|----------|-----------|
| **Максимальный размер карты** | Неограничен (15000x15000+) | ~5000x5000 |
| **Зависимость от цвета** | Нет | Да |
| **Скорость на CPU** | Медленно (10-30s) | Быстро (1-5s) |
| **Скорость на GPU** | Средне (1-5s) | Быстро (1-5s) |
| **Точность** | Высокая | Средняя |
| **Устойчивость к изменениям** | Высокая | Низкая |
| **Дополнительные библиотеки** | Да | Нет |

**Рекомендация**: Используйте ML метод для больших карт (>5000x5000) и когда важна устойчивость к изменениям. Для маленьких карт и быстрой обработки используйте ORB.

## Контакты

При возникновении проблем создайте issue в репозитории проекта.

